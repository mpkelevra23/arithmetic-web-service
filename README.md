# Arithmetic Web Service

## Описание проекта

Этот проект представляет собой распределенную систему вычисления арифметических выражений, разработанную на языке программирования Go. Система состоит из трех основных компонентов:

1. **Оркестратор** - сервер, который принимает арифметические выражения, разбивает их на атомарные задачи и управляет их выполнением.
2. **Агент** - вычислитель, который получает задачи от оркестратора, выполняет их и возвращает результаты.
3. **Веб-интерфейс** - простой фронтенд для взаимодействия с сервисом через браузер.

В системе арифметические операции намеренно симулируются как "медленные" и "ресурсоемкие", что требует их распределенного выполнения.

### Принцип работы

1. Пользователь отправляет запрос с арифметическим выражением на оркестратор (через API или веб-интерфейс).
2. Оркестратор разбирает выражение на атомарные операции и создает задачи с учетом зависимостей.
3. Агенты периодически запрашивают у оркестратора доступные задачи.
4. Агенты выполняют задачи (с искусственной задержкой) и отправляют результаты обратно оркестратору.
5. Оркестратор собирает результаты задач и вычисляет итоговый результат выражения.
6. Пользователь может проверить статус и результат выражения через API или веб-интерфейс.

## Быстрый старт

### Предварительные требования

- **Go:** Убедитесь, что у вас установлен Go версии 1.20 или выше.

### Клонирование репозитория

```bash
git clone https://github.com/mpkelevra23/arithmetic-web-service.git
cd arithmetic-web-service
```

### Установка зависимостей

Проект использует модули Go для управления зависимостями. Выполните следующую команду для установки необходимых пакетов:

```bash
go mod tidy
```

### Настройка конфигурации

Проект использует файл `.env` для конфигурации. Пример файла уже включен в репозиторий:

```env
# Порт для оркестратора
PORT=8080

# URL оркестратора для агента
ORCHESTRATOR_URL=http://localhost:8080

# Вычислительная мощность (количество воркеров)
COMPUTING_POWER=3

# Времена выполнения операций в миллисекундах
TIME_ADDITION_MS=100
TIME_SUBTRACTION_MS=100
TIME_MULTIPLICATIONS_MS=200
TIME_DIVISIONS_MS=200

# Уровень логирования
LOG_LEVEL=info
```

### Запуск системы

#### Запуск сервера с оркестратором и веб-интерфейсом

```bash
go run ./cmd/server/main.go
```

Сервер запустится на порту, указанном в `.env` (по умолчанию 8080).

## Использование веб-интерфейса

После запуска сервера веб-интерфейс доступен по адресу http://localhost:8080 (или другому порту, если он изменен в настройках).

1. Откройте браузер и перейдите по адресу http://localhost:8080
2. Введите арифметическое выражение в поле ввода (например, `2+2*2` или `(3+4)*2`)
3. Нажмите кнопку "Рассчитать" или клавишу Enter
4. Результат вычисления отобразится под формой

Веб-интерфейс автоматически отправляет запросы к API и отображает результаты или ошибки вычислений.

#### Запуск оркестратора (без веб-интерфейса)

```bash
go run ./cmd/orchestrator/main.go
```

Оркестратор запустится на порту, указанном в `.env` (по умолчанию 8080).

#### Запуск агента

```bash
go run ./cmd/agent/main.go
```

Агент подключится к оркестратору по URL, указанному в `.env` (по умолчанию http://localhost:8080).

## Использование API

### Добавление выражения для вычисления

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "expression": "2+2*2"
}'
```

**Ответ (201 Created):**

```json
{
    "id": 1
}
```

### Получение списка всех выражений

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/api/v1/expressions'
```

**Ответ (200 OK):**

```json
{
    "expressions": [
        {
            "id": 1,
            "expression": "2+2*2",
            "status": "PROCESSING"
        },
        {
            "id": 2,
            "expression": "3+4*2/(1-5)*2+3",
            "status": "COMPLETED",
            "result": "2"
        }
    ]
}
```

### Получение информации о конкретном выражении

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/api/v1/expressions/1'
```

**Ответ (200 OK):**

```json
{
    "expression": {
        "id": 1,
        "expression": "2+2*2",
        "status": "COMPLETED",
        "result": "6"
    }
}
```

### Примеры ошибок

#### 1. Недопустимое выражение (422)

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "expression": "2++2"
}'
```

**Ответ:**

```json
{
    "error": "Ошибка разбора выражения: неожиданный токен: +"
}
```

#### 2. Деление на ноль (422)

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "expression": "10/0"
}'
```

Агент вернёт ошибку деления на ноль, и выражение получит статус "ERROR".

#### 3. Выражение не найдено (404)

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/api/v1/expressions/999'
```

**Ответ:**

```json
{
    "error": "Выражение не найдено"
}
```

## Внутренний API для агентов

Эти эндпоинты используются агентами для получения задач и отправки результатов.

### Получение задачи для выполнения

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/internal/task'
```

**Ответ (200 OK):**

```json
{
    "task": {
        "id": 3,
        "expression_id": 1,
        "arg1": "2",
        "arg2": "2",
        "operation": "MULTIPLY",
        "operation_time": 200
    }
}
```

### Отправка результата задачи

**Запрос:**

```bash
curl -i --location 'http://localhost:8080/internal/task' \
--header 'Content-Type: application/json' \
--data '{
  "id": 3,
  "result": 4
}'
```

**Ответ (200 OK)** - пустой ответ с кодом 200.

## Конфигурация

### Переменные окружения

| Переменная | Описание | Значение по умолчанию |
|------------|----------|------------------------|
| PORT | Порт для HTTP-сервера | 8080 |
| ORCHESTRATOR_URL | URL оркестратора для агента | http://localhost:8080 |
| COMPUTING_POWER | Количество горутин-воркеров у агента | 3 |
| TIME_ADDITION_MS | Время выполнения сложения (мс) | 100 |
| TIME_SUBTRACTION_MS | Время выполнения вычитания (мс) | 100 |
| TIME_MULTIPLICATIONS_MS | Время выполнения умножения (мс) | 200 |
| TIME_DIVISIONS_MS | Время выполнения деления (мс) | 200 |
| LOG_LEVEL | Уровень логирования | info |

## Тестирование

Проект содержит модульные тесты для основных компонентов. Для запуска всех тестов используйте:

```bash
go test ./...
```

### Описание тестов

- **calculator_test.go:** Тестирует функцию `Calc` для различных арифметических выражений и проверяет корректность вычислений.
- **parser_test.go:** Тестирует разбор арифметических выражений на задачи.
- **agent_test.go:** Тестирует выполнение различных арифметических операций агентом.
- **handler_test.go:** Тестирует API-обработчики.
- **middleware_test.go:** Тестирует middleware для логирования.

## Пример сложного выражения

Выражение `3 + 4 * 2 / (1 - 5) * 2 + 3` будет разбито на следующие задачи:

1. Вычислить `1 - 5` = `-4`
2. Вычислить `4 * 2` = `8`
3. Вычислить `8 / -4` = `-2`
4. Вычислить `-2 * 2` = `-4`
5. Вычислить `3 + -4` = `-1`
6. Вычислить `-1 + 3` = `2`

Задачи будут выполняться с учетом зависимостей: задача 3 зависит от результатов задач 1 и 2, задача 4 зависит от задачи 3, и т.д.

## Логирование

Проект использует библиотеку Zap для структурированного логирования. Логи записываются как в консоль, так и в файлы:

- **Основные логи:** `logs/app.log`
- **Ошибки:** `logs/error.log`

Уровень логирования настраивается через переменную окружения `LOG_LEVEL` в файле `.env`.

## Масштабирование

Для увеличения производительности системы вы можете:

1. Увеличить количество воркеров у агента, изменив `COMPUTING_POWER` в `.env`.
2. Запустить несколько экземпляров агента, которые будут подключаться к одному оркестратору.

## Ограничения текущей реализации

1. Оркестратор хранит состояние в памяти - при перезапуске все выражения и задачи будут потеряны.
2. Нет механизма восстановления потерянных задач (если агент взял задачу, но не вернул результат).
3. Поддерживаются только базовые арифметические операции: +, -, *, /.